<div class="test-form-container">
  <div class="page-header hero">
    <div class="hero-left">
      <button
        mat-icon-button
        class="back-button"
        (click)="goBack()"
        [matTooltip]="'TEST_FORM.TOOLTIP_BACK' | translate"
      >
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="hero-titles">
        <h1>{{ getPageTitle() }}</h1>
        <p class="hero-subtitle">{{ 'TEST_FORM.SUBTITLE' | translate }}</p>
      </div>
    </div>

    <div class="hero-right">
      @if (isEditMode && currentTest) {
        <mat-chip-set>
          <mat-chip
            [highlighted]="isPublished()"
            [color]="isPublished() ? 'primary' : 'accent'"
          >
            {{ isPublished() ? ('TEST_FORM.STATUS_PUBLISHED' | translate) : ('TEST_FORM.STATUS_DRAFT' | translate) }}
          </mat-chip>
        </mat-chip-set>
      }

      <div class="hero-meta">
        <mat-icon>assignment</mat-icon>
        <span>{{ 'TEST_FORM.META' | translate }}</span>
      </div>
    </div>
  </div>

  @if (isPublished()) {
    <mat-card class="warning-card">
      <mat-icon>info</mat-icon>
      <div>
        <strong>{{ 'TEST_FORM.PUBLISHED_TITLE' | translate }}</strong>
        <p>{{ 'TEST_FORM.PUBLISHED_MESSAGE' | translate }}</p>
      </div>
    </mat-card>
  }

  <form [formGroup]="form" (ngSubmit)="submit()">
    <mat-card class="section-card">
      <mat-card-header class="section-header">
        <div class="section-header-inner">
          <div class="section-icon-wrap">
            <mat-icon class="section-icon">info</mat-icon>
          </div>
          <div>
            <mat-card-title>{{ 'TEST_FORM.SECTION_BASIC_TITLE' | translate }}</mat-card-title>
            <mat-card-subtitle>{{ 'TEST_FORM.SECTION_BASIC_SUBTITLE' | translate }}</mat-card-subtitle>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="form-grid">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'TEST_FORM.FIELD_NAME_LABEL' | translate }}</mat-label>
            <input
              matInput
              formControlName="name"
              [placeholder]="'TEST_FORM.FIELD_NAME_PLACEHOLDER' | translate"
              required
            >
            @if (form.get('name')?.invalid && form.get('name')?.touched) {
              <mat-error>
                @if (form.get('name')?.hasError('required')) {
                  {{ 'TEST_FORM.FIELD_NAME_ERROR_REQUIRED' | translate }}
                }
                @if (form.get('name')?.hasError('minlength')) {
                  {{ 'TEST_FORM.FIELD_NAME_ERROR_MIN' | translate }}
                }
                @if (form.get('name')?.hasError('maxlength')) {
                  {{ 'TEST_FORM.FIELD_NAME_ERROR_MAX' | translate }}
                }
              </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'TEST_FORM.FIELD_DESC_LABEL' | translate }}</mat-label>
            <textarea
              matInput
              formControlName="description"
              [placeholder]="'TEST_FORM.FIELD_DESC_PLACEHOLDER' | translate"
              rows="3"
            ></textarea>
            @if (form.get('description')?.invalid && form.get('description')?.touched) {
              <mat-error>
                {{ 'TEST_FORM.FIELD_DESC_ERROR_MAX' | translate }}
              </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>
              <span class="step-number">1.</span>
              {{ 'TEST_FORM.FIELD_CLASS_LEVEL_LABEL' | translate }}
            </mat-label>
            <mat-select formControlName="classLevelId" required>
              @if (classLevels && classLevels.length > 0) {
                @for (level of classLevels; track level.id) {
                  <mat-option [value]="level.id">
                    {{ level.level }} {{ 'TEST_FORM.FIELD_CLASS_LEVEL_SUFFIX' | translate }}
                  </mat-option>
                }
              } @else {
                <mat-option disabled>{{ 'TEST_FORM.FIELD_CLASS_LEVEL_LOADING' | translate }}</mat-option>
              }
            </mat-select>
            <mat-hint>{{ 'TEST_FORM.FIELD_CLASS_LEVEL_HINT' | translate }}</mat-hint>
            @if (form.get('classLevelId')?.invalid && form.get('classLevelId')?.touched) {
              <mat-error>{{ 'TEST_FORM.FIELD_CLASS_LEVEL_REQUIRED' | translate }}</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>
              <span class="step-number">2.</span>
              {{ 'TEST_FORM.FIELD_SUBJECT_LABEL' | translate }}
            </mat-label>
            <mat-select formControlName="subjectId" required>
              @if (subjects && subjects.length > 0) {
                @for (subject of subjects; track subject.id) {
                  <mat-option [value]="subject.id">
                    {{ subject.nameRu }}
                  </mat-option>
                }
              } @else {
                <mat-option disabled>{{ 'TEST_FORM.FIELD_SUBJECT_LOADING' | translate }}</mat-option>
              }
            </mat-select>
            <mat-hint>{{ 'TEST_FORM.FIELD_SUBJECT_HINT_NEW' | translate }}</mat-hint>
            @if (form.get('subjectId')?.invalid && form.get('subjectId')?.touched) {
              <mat-error>{{ 'TEST_FORM.FIELD_SUBJECT_REQUIRED' | translate }}</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>
              <span class="step-number">3.</span>
              {{ 'TEST_FORM.FIELD_SCHOOL_CLASSES_LABEL' | translate }}
            </mat-label>
            <mat-select formControlName="schoolClassIds" required multiple>
              @if (schoolClasses && schoolClasses.length > 0) {
                @for (schoolClass of schoolClasses; track schoolClass.id) {
                  <mat-option [value]="schoolClass.id">
                    {{ schoolClass.code }}
                  </mat-option>
                }
              } @else {
                <mat-option disabled>{{ 'TEST_FORM.FIELD_SCHOOL_CLASSES_LOADING' | translate }}</mat-option>
              }
            </mat-select>
            <mat-hint>{{ 'TEST_FORM.FIELD_SCHOOL_CLASSES_HINT' | translate }}</mat-hint>
            @if (form.get('schoolClassIds')?.invalid && form.get('schoolClassIds')?.touched) {
              <mat-error>{{ 'TEST_FORM.FIELD_SCHOOL_CLASSES_REQUIRED' | translate }}</mat-error>
            }
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="section-card">
      <mat-card-header class="section-header">
        <div class="section-header-inner">
          <div class="section-icon-wrap">
            <mat-icon class="section-icon">settings</mat-icon>
          </div>
          <div>
            <mat-card-title>{{ 'TEST_FORM.SECTION_SETTINGS_TITLE' | translate }}</mat-card-title>
            <mat-card-subtitle>{{ 'TEST_FORM.SECTION_SETTINGS_SUBTITLE' | translate }}</mat-card-subtitle>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'TEST_FORM.FIELD_DURATION_LABEL' | translate }}</mat-label>
            <input
              matInput
              type="number"
              [value]="getDurationInMinutes()"
              (input)="updateDurationFromMinutes($any($event.target).value)"
              min="1"
              max="240"
              required
            >
            <mat-hint>{{ formatDuration(form.get('durationSec')?.value || 3600) }}</mat-hint>
            @if (form.get('durationSec')?.invalid && form.get('durationSec')?.touched) {
              <mat-error>{{ 'TEST_FORM.FIELD_DURATION_ERROR' | translate }}</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'TEST_FORM.FIELD_ATTEMPTS_LABEL' | translate }}</mat-label>
            <input
              matInput
              type="number"
              formControlName="allowedAttempts"
              min="1"
              max="10"
              required
            >
            <mat-hint>{{ 'TEST_FORM.FIELD_ATTEMPTS_HINT' | translate }}</mat-hint>
            @if (form.get('allowedAttempts')?.invalid && form.get('allowedAttempts')?.touched) {
              <mat-error>{{ 'TEST_FORM.FIELD_ATTEMPTS_ERROR' | translate }}</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'TEST_FORM.FIELD_PASSING_LABEL' | translate }}</mat-label>
            <input
              matInput
              type="number"
              formControlName="passingPercent"
              min="0"
              max="100"
              required
            >
            <span matTextSuffix>%</span>
            <mat-hint>{{ 'TEST_FORM.FIELD_PASSING_HINT' | translate }}</mat-hint>
            @if (form.get('passingPercent')?.invalid && form.get('passingPercent')?.touched) {
              <mat-error>{{ 'TEST_FORM.FIELD_PASSING_ERROR' | translate }}</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'TEST_FORM.FIELD_REVIEW_LABEL' | translate }}</mat-label>
            <mat-select formControlName="reviewPolicy" required>
              @for (policy of reviewPolicyOptions; track policy.value) {
                <mat-option [value]="policy.value">
                  {{ ('TEST_FORM.REVIEW_OPTION_' + policy.value) | translate }}
                </mat-option>
              }
            </mat-select>
            <mat-hint>
              @if (form.get('reviewPolicy')?.value === 'AFTER_SUBMIT') {
                {{ 'TEST_FORM.REVIEW_HINT_AFTER_SUBMIT' | translate }}
              } @else if (form.get('reviewPolicy')?.value === 'AFTER_CLOSE') {
                {{ 'TEST_FORM.REVIEW_HINT_AFTER_CLOSE' | translate }}
              } @else {
                {{ 'TEST_FORM.REVIEW_HINT_NEVER' | translate }}
              }
            </mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="section-card">
      <mat-card-header class="section-header">
        <div class="section-header-inner">
          <div class="section-icon-wrap">
            <mat-icon class="section-icon">schedule</mat-icon>
          </div>
          <div>
            <mat-card-title>{{ 'TEST_FORM.SECTION_SCHEDULE_TITLE' | translate }}</mat-card-title>
            <mat-card-subtitle>{{ 'TEST_FORM.SECTION_SCHEDULE_SUBTITLE' | translate }}</mat-card-subtitle>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'TEST_FORM.FIELD_OPENS_DATE_LABEL' | translate }}</mat-label>
            <input
              matInput
              [matDatepicker]="opensAtPicker"
              formControlName="opensAt"
              [placeholder]="'TEST_FORM.FIELD_OPENS_PLACEHOLDER' | translate"
            >
            <mat-datepicker-toggle matIconSuffix [for]="opensAtPicker"></mat-datepicker-toggle>
            <mat-datepicker #opensAtPicker></mat-datepicker>
            <mat-hint>{{ 'TEST_FORM.FIELD_OPENS_DATE_HINT' | translate }}</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'TEST_FORM.FIELD_OPENS_TIME_LABEL' | translate }}</mat-label>
            <input
              matInput
              type="time"
              formControlName="opensTime"
              [placeholder]="'TEST_FORM.FIELD_OPENS_TIME_PLACEHOLDER' | translate"
            >
            <mat-icon matIconPrefix>schedule</mat-icon>
            <mat-hint>{{ 'TEST_FORM.FIELD_OPENS_TIME_HINT' | translate }}</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'TEST_FORM.FIELD_CLOSES_DATE_LABEL' | translate }}</mat-label>
            <input
              matInput
              [matDatepicker]="closesAtPicker"
              formControlName="closesAt"
              [placeholder]="'TEST_FORM.FIELD_CLOSES_PLACEHOLDER' | translate"
            >
            <mat-datepicker-toggle matIconSuffix [for]="closesAtPicker"></mat-datepicker-toggle>
            <mat-datepicker #closesAtPicker></mat-datepicker>
            <mat-hint>{{ 'TEST_FORM.FIELD_CLOSES_DATE_HINT' | translate }}</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'TEST_FORM.FIELD_CLOSES_TIME_LABEL' | translate }}</mat-label>
            <input
              matInput
              type="time"
              formControlName="closesTime"
              [placeholder]="'TEST_FORM.FIELD_CLOSES_TIME_PLACEHOLDER' | translate"
            >
            <mat-icon matIconPrefix>schedule</mat-icon>
            <mat-hint>{{ 'TEST_FORM.FIELD_CLOSES_TIME_HINT' | translate }}</mat-hint>
          </mat-form-field>

          @if (form.hasError('scheduleInvalid')) {
            <div class="schedule-error full-width">
              <mat-icon>error</mat-icon>
              <span>{{ 'TEST_FORM.SCHEDULE_ERROR' | translate }}</span>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="section-card">
      <mat-card-header class="section-header">
        <div class="section-header-inner">
          <div class="section-icon-wrap">
            <mat-icon class="section-icon">tune</mat-icon>
          </div>
          <div>
            <mat-card-title>{{ 'TEST_FORM.SECTION_OPTIONS_TITLE' | translate }}</mat-card-title>
            <mat-card-subtitle>{{ 'TEST_FORM.SECTION_OPTIONS_SUBTITLE' | translate }}</mat-card-subtitle>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="options-container">
          <div class="option-item">
            <mat-checkbox formControlName="shuffleQuestions">
              {{ 'TEST_FORM.OPTION_SHUFFLE_QUESTIONS' | translate }}
            </mat-checkbox>
            <span class="option-description">
              {{ 'TEST_FORM.OPTION_SHUFFLE_QUESTIONS_DESC' | translate }}
            </span>
          </div>

          <div class="option-item">
            <mat-checkbox formControlName="shuffleChoices">
              {{ 'TEST_FORM.OPTION_SHUFFLE_CHOICES' | translate }}
            </mat-checkbox>
            <span class="option-description">
              {{ 'TEST_FORM.OPTION_SHUFFLE_CHOICES_DESC' | translate }}
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="actions-section">
      <div class="left-actions">
        @if (isEditMode) {
        <button
          mat-raised-button
          class="aqyldy-btn-mint"
          type="button"
          (click)="navigateToComposition()"
          [disabled]="loading"
          [matTooltip]="'TEST_FORM.TOOLTIP_EDIT_QUESTIONS' | translate"
        >
            <mat-icon>list</mat-icon>
            {{ 'TEST_FORM.ACTION_EDIT_QUESTIONS' | translate }}
          </button>
        }

        @if (isEditMode && !isPublished()) {
          <button
            mat-raised-button
            color="accent"
            type="button"
            (click)="publish()"
            [disabled]="loading || form.invalid || !isCompositionPlanFulfilled()"
            [matTooltip]="isCompositionPlanFulfilled() ?
              ('TEST_FORM.TOOLTIP_PUBLISH' | translate) :
              getPlanFulfillmentMessage()"
          >
            <mat-icon>publish</mat-icon>
            {{ 'TEST_FORM.ACTION_PUBLISH' | translate }}
          </button>
        }
      </div>

      <div class="right-actions">
        <button
          mat-button
          type="button"
          (click)="goBack()"
          [disabled]="loading"
        >
          {{ 'TEST_FORM.ACTION_CANCEL' | translate }}
        </button>

        @if (isEditMode && !hasAttempts()) {
          <button
            mat-raised-button
            color="warn"
            type="button"
            (click)="delete()"
            [disabled]="loading"
            [matTooltip]="'TEST_FORM.TOOLTIP_DELETE' | translate"
          >
            <mat-icon>delete</mat-icon>
            {{ 'TEST_FORM.ACTION_DELETE' | translate }}
          </button>
        }

        @if (isEditMode && hasAttempts()) {
          <button
            mat-raised-button
            color="warn"
            type="button"
            disabled
            [matTooltip]="'TEST_FORM.TOOLTIP_DELETE_DISABLED' | translate"
          >
            <mat-icon>delete</mat-icon>
            {{ 'TEST_FORM.ACTION_DELETE' | translate }}
          </button>
        }

        <button
          mat-raised-button
          class="aqyldy-btn-mint"
          type="submit"
          [disabled]="form.invalid || loading || isPublished()"
        >
          <mat-icon>save</mat-icon>
          {{ getSubmitButtonText() }}
        </button>
      </div>
    </div>
  </form>
</div>
