<div class="composition-container">
  <!-- Header -->
  <div class="page-header hero">
    <div class="hero-left">
      <button mat-icon-button class="back-button" (click)="goBack()" matTooltip="Back to test">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div>
        <h1>Test Composition</h1>
        <p class="hero-subtitle">{{ test()?.title }}</p>
      </div>
    </div>

    <div class="hero-right">
      @if (isPublished()) {
        <mat-chip highlighted color="primary">Published</mat-chip>
      }
      <div class="hero-meta">
        <mat-icon>quiz</mat-icon>
        <span>Questions: {{ testQuestions().length }}</span>
      </div>
    </div>
  </div>

  <!-- Warning for published tests -->
  @if (isPublished()) {
    <mat-card class="warning-card">
      <mat-icon>lock</mat-icon>
      <div>
        <strong>Test is published</strong>
        <p>You cannot modify the composition of a published test.</p>
      </div>
    </mat-card>
  }

  <!-- Planning Section -->
  @if (!isPublished()) {
    <mat-card class="planning-section">
      <mat-card-header>
        <mat-card-title>План теста</mat-card-title>
        <div class="plan-progress">
          Выбрано {{ getPlanProgress().totalSelected }} из {{ getPlanProgress().totalTarget }} вопросов
        </div>
      </mat-card-header>

      <mat-card-content>
        @if (testPlan() && testPlan()!.topicPlans.length > 0) {
          <!-- Plan Table -->
          <table class="plan-table">
            <thead>
              <tr>
                <th>Топик</th>
                <th>Требуется</th>
                <th>Доступно</th>
                <th>Выбрано</th>
                <th>Прогресс</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody>
              @for (topicPlan of testPlan()!.topicPlans; track topicPlan.topicId) {
                <tr>
                  <td>{{ topicPlan.topicName }}</td>
                  <td>
                    <mat-form-field appearance="outline" class="compact-field">
                      <input
                        matInput
                        type="number"
                        min="1"
                        max="50"
                        [value]="topicPlan.targetCount"
                        (change)="updateTopicTargetCount(topicPlan.topicId, +$any($event.target).value)"
                      >
                    </mat-form-field>
                  </td>
                  <td>
                    <span class="available-count">{{ getAvailableQuestionsCount(topicPlan.topicId) }}</span>
                  </td>
                  <td>{{ getTopicProgress(topicPlan.topicId).selected }}</td>
                  <td>
                    <div class="progress-bar-container">
                      <mat-progress-bar
                        mode="determinate"
                        [value]="getTopicProgress(topicPlan.topicId).percentage"
                        [color]="getTopicProgress(topicPlan.topicId).isFulfilled ? 'primary' : 'accent'"
                      ></mat-progress-bar>
                      <span class="progress-text">
                        {{ getTopicProgress(topicPlan.topicId).percentage }}%
                      </span>
                    </div>
                  </td>
                  <td>
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="removeTopicFromPlan(topicPlan.topicId)"
                      matTooltip="Удалить из плана"
                    >
                      <mat-icon>remove_circle</mat-icon>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>

          <!-- Overall Progress -->
          <div class="overall-progress" [class.not-fulfilled]="!getPlanProgress().isFulfilled">
            <mat-icon [color]="getPlanProgress().isFulfilled ? 'primary' : ''">
              {{ getPlanProgress().isFulfilled ? 'check_circle' : 'pending' }}
            </mat-icon>
            <span>
              План {{ getPlanProgress().isFulfilled ? 'выполнен' : 'не выполнен' }}:
              {{ getPlanProgress().totalSelected }}/{{ getPlanProgress().totalTarget }}
            </span>
          </div>
        }

        <!-- Plan Actions -->
        <div class="plan-actions">
          <button
            mat-stroked-button
            color="primary"
            (click)="openAddTopicDialog()"
          >
            <mat-icon>add</mat-icon>
            Добавить топик в план
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Two-panel layout -->
  <div class="panels-container">
    <!-- Left Panel: Question Bank -->
    <mat-card class="panel question-bank">
      <mat-card-header>
        <mat-card-title>Question Bank</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <!-- Question List grouped by topics -->
        @if (groupedAvailableQuestions().length > 0) {
          @for (group of groupedAvailableQuestions(); track group.topicId) {
            <!-- Topic Header -->
            <div class="topic-group-header question-bank-header" (click)="toggleQuestionBankTopicCollapse(group.topicId)">
              <mat-icon>topic</mat-icon>
              <span class="topic-name">{{ group.topicName }}</span>
              <span class="topic-count">({{ group.questions.length }})</span>
              <mat-icon class="collapse-icon">
                {{ isQuestionBankTopicCollapsed(group.topicId) ? 'expand_more' : 'expand_less' }}
              </mat-icon>
            </div>

            <!-- Topic Questions List -->
            @if (!isQuestionBankTopicCollapsed(group.topicId)) {
              <mat-list class="question-list">
              @for (question of group.questions; track question.id) {
                <mat-list-item>
                  <div class="question-item">
                    <mat-checkbox
                      [checked]="isQuestionSelected(question.id)"
                      (change)="onQuestionCheckboxChange(question, $event.checked)"
                      [disabled]="isPublished()"
                      color="primary"
                    ></mat-checkbox>
                    <div class="question-content" (click)="viewQuestion(question)">
                      <span class="question-text">{{ question.text }}</span>
                      <mat-chip-set>
                        <mat-chip [color]="getDifficultyColor(question.difficulty)" highlighted>
                          {{ question.difficulty }}
                        </mat-chip>
                      </mat-chip-set>
                    </div>
                  </div>
                </mat-list-item>
                <mat-divider></mat-divider>
              } @empty {
                <div class="no-data-small">
                  <small>Нет вопросов</small>
                </div>
              }
              </mat-list>
            }
          }
        } @else {
          <div class="no-data">
            <mat-icon>search_off</mat-icon>
            <p>No questions found</p>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Right Panel: Test Basket -->
    <mat-card class="panel test-basket">
      <mat-card-header>
        <mat-card-title>Вопросы теста ({{ testQuestions().length }})</mat-card-title>
        <div class="total-score">
          Всего баллов: <strong>{{ getTotalScore() }}</strong>
        </div>
      </mat-card-header>

      <mat-card-content>
        <!-- Grouped by topics -->
        @if (groupedTestQuestions().length > 0) {
          @for (group of groupedTestQuestions(); track group.topicId) {
            <!-- Topic Header -->
            <div class="topic-group-header" (click)="toggleTestTopicCollapse(group.topicId)">
              <mat-icon>topic</mat-icon>
              <span class="topic-name">{{ group.topicName }}</span>
              <span class="topic-count">
                ({{ group.questions.length }}
                @if (getTopicTargetCount(group.topicId) > 0) {
                  / {{ getTopicTargetCount(group.topicId) }}
                })
              </span>
              <mat-chip
                [color]="isTopicFulfilled(group.topicId) ? 'primary' : 'accent'"
                highlighted
                (click)="$event.stopPropagation()"
              >
                {{ isTopicFulfilled(group.topicId) ? 'Выполнено' : 'В процессе' }}
              </mat-chip>
              <mat-icon class="collapse-icon">
                {{ isTestTopicCollapsed(group.topicId) ? 'expand_more' : 'expand_less' }}
              </mat-icon>
            </div>

            <!-- Topic Questions List -->
            @if (!isTestTopicCollapsed(group.topicId)) {
              <mat-list
              cdkDropList
              [id]="'topic-' + group.topicId"
              (cdkDropListDropped)="onDropWithinTopic($event, group.topicId)"
              class="topic-question-list"
            >
              @for (tq of group.questions; track tq.questionId) {
                <mat-list-item cdkDrag [cdkDragDisabled]="isPublished()">
                  <div class="test-question-item">
                    <!-- Drag Handle -->
                    <mat-icon cdkDragHandle class="drag-handle" *ngIf="!isPublished()">
                      drag_indicator
                    </mat-icon>

                    <!-- Question Text with Number -->
                    <div class="question-content" (click)="viewTestQuestion(tq)" style="cursor: pointer;">
                      <span class="question-text">
                        <strong class="question-number">{{ tq.order + 1 }}.</strong> {{ tq.questionText || 'Вопрос ' + (tq.order + 1) }}
                      </span>
                    </div>

                    <!-- Weight Display (Auto-calculated) -->
                    <mat-form-field appearance="outline" class="weight-field">
                      <mat-label>Баллы</mat-label>
                      <input
                        matInput
                        type="number"
                        [value]="getWeight(tq.questionId)"
                        readonly
                        disabled
                      >
                      <mat-hint>Авто</mat-hint>
                    </mat-form-field>

                    <!-- Remove Button -->
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="removeQuestionFromTest(tq)"
                      [disabled]="isPublished()"
                      matTooltip="Удалить"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </mat-list-item>
                <mat-divider></mat-divider>
              }
              </mat-list>
            }
          }
        } @else {
          <div class="no-data">
            <mat-icon>assignment</mat-icon>
            <p>Нет вопросов</p>
            <small>Добавьте вопросы из банка слева или сгенерируйте автоматически</small>
          </div>
        }
      </mat-card-content>

      <!-- Save Button -->
      <mat-card-actions>
        <button
          mat-raised-button
          class="aqyldy-btn-mint"
          (click)="saveComposition()"
          [disabled]="loading() || isPublished() || testQuestions().length === 0"
        >
          <mat-icon>save</mat-icon>
          {{ loading() ? 'Saving...' : 'Save Composition' }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
